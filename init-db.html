<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Inicjalizacja Bazy Danych</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        button { font-size: 1.5rem; padding: 20px; cursor: pointer; }
        #log { margin-top: 20px; border: 1px solid #ccc; padding: 10px; width: 80%; height: 200px; overflow-y: scroll; font-family: monospace; }
    </style>
</head>
<body>

    <h1>Generator Harmonogramu w Firestore</h1>
    <p><strong>Uwaga:</strong> Ten skrypt usunie wszystkie istniejące dane w kolekcji 'schedules' i utworzy nową, pustą siatkę.</p>
    <button id="initButton">Start - Generuj Harmonogram</button>
    <div id="log">Czekam na rozpoczęcie...</div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        const initButton = document.getElementById('initButton');
        const logDiv = document.getElementById('log');

        const therapists = [
            'AGATA (771)', 'MACIEK (712)', 'ANIA (657)', 'KASIA S (665)', 'MARTA (737)', 
            'GOSIA (662)', 'KAROLINA K (658)', 'MAGDA (659)', 'JUSTYNA (774)', 
            'KAMILA (660)', 'RUDA (747)', 'KLAUDIA', 'ASIA'
        ];

        const startTime = 7 * 60; // 7:00
        const endTime = 17 * 60 + 30; // 17:30
        const interval = 30; // minuty

        function log(message) {
            logDiv.innerHTML += message + '<br>';
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function deleteCollection(db, collectionPath) {
            const collectionRef = db.collection(collectionPath);
            const query = collectionRef.orderBy('__name__').limit(100);

            return new Promise((resolve, reject) => {
                deleteQueryBatch(db, query, resolve, reject);
            });
        }

        async function deleteQueryBatch(db, query, resolve, reject) {
            const snapshot = await query.get();
            if (snapshot.size === 0) {
                resolve();
                return;
            }

            const batch = db.batch();
            snapshot.docs.forEach(doc => {
                batch.delete(doc.ref);
            });
            await batch.commit();

            process.nextTick(() => {
                deleteQueryBatch(db, query, resolve, reject);
            });
        }

        initButton.addEventListener('click', async () => {
            initButton.disabled = true;
            log('Rozpoczynam proces...');

            try {
                log("Krok 1/3: Czyszczenie istniejącej kolekcji 'schedules'...");
                // UWAGA: To jest uproszczone czyszczenie, może nie działać na dużych kolekcjach, ale tu wystarczy.
                const oldDocs = await db.collection('schedules').get();
                const batchDelete = db.batch();
                oldDocs.forEach(doc => batchDelete.delete(doc.ref));
                await batchDelete.commit();
                log('Kolekcja wyczyszczona.');

                log('Krok 2/3: Generowanie nowych danych...');
                const batchWrite = db.batch();

                for (let minutes = startTime; minutes <= endTime; minutes += interval) {
                    const hour = Math.floor(minutes / 60).toString().padStart(2, '0');
                    const minute = (minutes % 60).toString().padStart(2, '0');
                    const timeString = `${hour}:${minute}`;
                    
                    const docRef = db.collection('schedules').doc(timeString); // Używamy czasu jako ID
                    
                    const slots = {};
                    therapists.forEach(therapist => {
                        slots[therapist] = { text: '', type: 'normal' }; // Domyślna wartość
                    });

                    batchWrite.set(docRef, { time: timeString, slots: slots });
                    log(`Przygotowano dokument dla ${timeString}`);
                }

                log('Krok 3/3: Zapisywanie danych w bazie...');
                await batchWrite.commit();

                log('<strong>ZAKOŃCZONO SUKCESEM!</strong>');
                log('Możesz teraz zamknąć tę kartę i odświeżyć główną aplikację.');

            } catch (error) {
                log('<strong>WYSTĄPIŁ BŁĄD:</strong> ' + error.message);
                console.error(error);
                initButton.disabled = false;
            }
        });
    </script>
</body>
</html>
